{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {

        "location": {
            "type": "string"
        },
        "subnetId": {
            "type": "string"
        },
        "lbname": {
            "type": "string"
        },
        "lbsku": {
            "type": "string"
        },
        "LbprivateIPAllocationMethod": {
            "type": "string"
        },
        "LbprivateIPAddress": {
            "type": "string"
        },
        "networkSecurityGroupRules": {
          "type": "array"
      }

    },
    "variables":
        {
            "lbID": "[resourceId('Microsoft.Network/loadBalancers',parameters('lbName'))]",
            "frontEndIPConfigID": "[concat(variables('lbID'),'/frontendIPConfigurations/NFSFrontEnd')]",
            "lbPoolID": "[concat(variables('lbID'),'/backendAddressPools/BackendNFS')]",
            "lbProbeID": "[concat(variables('lbID'),'/probes/NFStcpProbe')]",
            "networkSecurityGroupName" : "[concat(parameters('lbName'),'-NSG')]",
            "networkSecurityGroupId" : "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]",
            "publicIPAddressName": "[concat(parameters('lbName'),'-PIP')]",
            "publicIPAddressId" : "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]"
        },
    "resources": [
      {
        "name": "[variables('networkSecurityGroupName')]",
        "type": "Microsoft.Network/networkSecurityGroups",
        "apiVersion": "2019-02-01",
        "location": "[parameters('location')]",
        "properties": {
            "securityRules": "[parameters('networkSecurityGroupRules')]"
        }
      },
      {
      "apiVersion": "2019-02-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressName')]",
      "location": "[parameters('location')]",
      "sku": {
          "name": "Standard"
      },
      "tags": {},
      "properties": {
          "publicIPAllocationMethod": "Static",
          "publicIPAddressVersion": "IPv4",
          "ipTags": []
      }
    },  
      {
            "name": "[parameters('lbname')]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2019-06-01",
            "location": "[parameters('location')]",
            "sku": {
                "name": "[parameters('lbsku')]"
            },
            "dependsOn": [],
            "tags": {},
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "NFSFrontEnd",
                        "properties": {
                          "publicIPAddress": {
                            "id": "[variables('publicIPAddressId')]"
                        }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                      "name": "BackendNFS"
                    }
                ],
                "probes": [
                    {
                      "name": "NFStcpProbe",
                      "properties": {
                        "protocol": "Tcp",
                        "port": 61000,
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                      }
                    }
                  ],
                  "loadBalancingRules": [
                    {
                      "name": "NFSTcpLBRule",
                      "properties": {
                        "frontendIPConfiguration": {
                          "id": "[variables('frontEndIPConfigID')]"
                        },
                        "backendAddressPool": {
                          "id": "[variables('lbPoolID')]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": 2049,
                        "backendPort": 2049,
                        "enableFloatingIP": true,
                        "idleTimeoutInMinutes": 30,
                        "probe": {
                          "id": "[variables('lbProbeID')]"
                        }
                      }
                    },
                    {
                        "name": "NFSUdpLBRule",
                        "properties": {
                          "frontendIPConfiguration": {
                            "id": "[variables('frontEndIPConfigID')]"
                          },
                          "backendAddressPool": {
                            "id": "[variables('lbPoolID')]"
                          },
                          "protocol": "Udp",
                          "frontendPort": 2049,
                          "backendPort": 2049,
                          "enableFloatingIP": true,
                          "idleTimeoutInMinutes": 30,
                          "probe": {
                            "id": "[variables('lbProbeID')]"
                          }
                        }
                      }
                  ]
            }
        }

    ],
    "outputs": {
      "publicIPAddressNameId": {
        "type": "string",
        "value": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
    }
    }
}